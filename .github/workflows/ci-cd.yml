name: Web IDE Backend CI/CD

# ì›Œí¬í”Œë¡œìš° ì‹¤í–‰ ì¡°ê±´
on:
  push:
    branches:
      - test        # test ë¸Œëœì¹˜ì— pushë  ë•Œ ì‹¤í–‰ë¨
  pull_request:
    branches:
      - test        # test ë¸Œëœì¹˜ë¡œ PRì´ ì—´ë¦´ ë•Œë„ ì‹¤í–‰ë¨

# í™˜ê²½ ë³€ìˆ˜ ì •ì˜ (Secretsë¡œ ë¯¼ê° ì •ë³´ ê´€ë¦¬)
env:
  AWS_REGION: ap-northeast-2                    # AWS ë¦¬ì „ (í•„ìš”ì‹œ í™•ì¥ìš©)
  EC2_HOST: ${{ secrets.EC2_HOST }}             # EC2 í¼ë¸”ë¦­ IP ë˜ëŠ” ë„ë©”ì¸ (Secretsì— ë“±ë¡)
  EC2_USER: ubuntu                              # EC2 ì‚¬ìš©ì ì´ë¦„ (ex. ubuntu)
  PRIVATE_KEY: ${{ secrets.EC2_SSH_KEY }}       # EC2ì— ì ‘ê·¼í•  SSH ê°œì¸ í‚¤
  BACKEND_IMAGE: webide-backend                 # Docker ì´ë¯¸ì§€ ì´ë¦„
  DOCKER_USERNAME: ${{ secrets.DOCKER_USERNAME }} # Docker Hub ID
  DOCKER_PASSWORD: ${{ secrets.DOCKER_PASSWORD }} # Docker Hub ë¹„ë°€ë²ˆí˜¸

jobs:
  backend-deploy:
    runs-on: ubuntu-latest                      # GitHubì—ì„œ ì œê³µí•˜ëŠ” Ubuntu í™˜ê²½ì—ì„œ ì‹¤í–‰

    steps:
      # 1. ì†ŒìŠ¤ì½”ë“œ ì²´í¬ì•„ì›ƒ
      - name: ğŸ”„ Checkout source code
        uses: actions/checkout@v3
        # ì €ì¥ì†Œì˜ ìµœì‹  ì½”ë“œë¥¼ ë°›ì•„ì˜´

      # 2. Docker Hub ë¡œê·¸ì¸
      - name: ğŸ” Docker Hub ë¡œê·¸ì¸
        run: echo "${{ env.DOCKER_PASSWORD }}" | docker login -u "${{ env.DOCKER_USERNAME }}" --password-stdin
        # Docker Hubì— ë¡œê·¸ì¸í•˜ì—¬ ì´ë¯¸ì§€ë¥¼ pushí•  ìˆ˜ ìˆë„ë¡ ì¸ì¦

      # 3. ë°±ì—”ë“œ Docker ì´ë¯¸ì§€ ë¹Œë“œ ë° Docker Hubì— Push
      - name: ğŸ³ Backend Docker ì´ë¯¸ì§€ ë¹Œë“œ ë° í‘¸ì‹œ
        run: |
          docker build -t $DOCKER_USERNAME/$BACKEND_IMAGE:latest -f docker/backend.Dockerfile ./backend
          docker push $DOCKER_USERNAME/$BACKEND_IMAGE:latest
        # ./backend í´ë”ì— ìˆëŠ” ì†ŒìŠ¤ë¥¼ ê¸°ë°˜ìœ¼ë¡œ docker/backend.Dockerfileì„ ì´ìš©í•´ ì´ë¯¸ì§€ ìƒì„±
        # ì´ë¯¸ì§€ íƒœê·¸: webide-backend:latest
        # ìƒì„±í•œ ì´ë¯¸ì§€ë¥¼ Docker Hubì— ì—…ë¡œë“œ

      # 4. EC2 ì„œë²„ì— SSHë¡œ ì ‘ì† í›„ ë°±ì—”ë“œ ì»¨í…Œì´ë„ˆ ë°°í¬
      - name: ğŸš€ EC2ì— SSH ì ‘ì† ë° Backend ë°°í¬
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ env.EC2_HOST }}
          username: ${{ env.EC2_USER }}
          key: ${{ env.PRIVATE_KEY }}
          script: |
            docker pull $DOCKER_USERNAME/$BACKEND_IMAGE:latest
          # ìµœì‹  ì´ë¯¸ì§€ë¥¼ Docker Hubì—ì„œ EC2ë¡œ pull

            docker stop webide-backend || true && docker rm webide-backend || true
          # ì´ì „ì— ì‹¤í–‰ ì¤‘ì´ë˜ ì»¨í…Œì´ë„ˆê°€ ìˆìœ¼ë©´ ì¤‘ì§€í•˜ê³  ì œê±° (ì—†ì–´ë„ ì—ëŸ¬ ì•ˆ ë‚¨)

            docker run -d --name webide-backend -p 8080:8080 $DOCKER_USERNAME/$BACKEND_IMAGE:latest
          # ìƒˆë¡œ ë°›ì€ ì´ë¯¸ì§€ë¥¼ ê¸°ë°˜ìœ¼ë¡œ ì»¨í…Œì´ë„ˆ ì‹¤í–‰
          # EC2ì˜ 8080 í¬íŠ¸ë¥¼ ì»¨í…Œì´ë„ˆì˜ 8080ì— ì—°ê²°
