name: Web IDE Backend CI/CD

on:
  push:
    branches: [ main ]  # main ë¸Œëœì¹˜ì— push ë  ë•Œ ì‹¤í–‰
  pull_request:
    branches: [ main ]  # main ë¸Œëœì¹˜ë¡œ PR ìƒì„± ì‹œ ì‹¤í–‰

env:
  AWS_REGION: ap-northeast-2
  EC2_HOST: ${{ secrets.EC2_HOST }}         # EC2 í¼ë¸”ë¦­ IP
  EC2_USER: ubuntu                          # EC2 ì‚¬ìš©ì (ë³´í†µ ubuntu)
  PRIVATE_KEY: ${{ secrets.EC2_SSH_KEY }}   # EC2 .pem í‚¤ (Secretsì— í…ìŠ¤íŠ¸ë¡œ ë“±ë¡)
  BACKEND_IMAGE: webide-backend             # Docker ì´ë¯¸ì§€ ì´ë¦„
  DOCKER_USERNAME: ${{ secrets.DOCKER_USERNAME }}
  DOCKER_PASSWORD: ${{ secrets.DOCKER_PASSWORD }}

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # CI(ì§€ì†ì  í†µí•©) ë‹¨ê³„
      # 1. GitHub ì½”ë“œ ì²´í¬ì•„ì›ƒ
      - name: ğŸ”„ Checkout source code
        uses: actions/checkout@v3

      # 2. Docker Hub ë¡œê·¸ì¸
      - name: ğŸ” Docker Hub ë¡œê·¸ì¸
        run: echo "${{ env.DOCKER_PASSWORD }}" | docker login -u "${{ env.DOCKER_USERNAME }}" --password-stdin

      # 3. Docker ì´ë¯¸ì§€ ë¹Œë“œ ë° ì—…ë¡œë“œ
      - name: ğŸ³ Docker ì´ë¯¸ì§€ ë¹Œë“œ ë° Push
        run: |
          docker build -t $DOCKER_USERNAME/$BACKEND_IMAGE:latest -f Dockerfile .
          docker push $DOCKER_USERNAME/$BACKEND_IMAGE:latest

#      # CD(ì§€ì†ì  ë°°í¬) ë‹¨ê³„
#      # 4. EC2ì— SSHë¡œ ì ‘ì†í•´ ë°°í¬
#      - name: ğŸš€ EC2 ë°°í¬ (ì»¨í…Œì´ë„ˆ êµì²´)
#        uses: appleboy/ssh-action@v1.0.0
#        with:
#          host: ${{ env.EC2_HOST }}
#          username: ${{ env.EC2_USER }}
#          key: ${{ env.PRIVATE_KEY }}
#          script: |
#            docker pull $DOCKER_USERNAME/$BACKEND_IMAGE:latest
#            docker stop webide-backend || true
#            docker rm webide-backend || true
#            docker run -d --name webide-backend -p 8080:8080 $DOCKER_USERNAME/$BACKEND_IMAGE:latest
